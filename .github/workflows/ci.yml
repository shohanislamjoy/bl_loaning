name: Easy Loan CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  FLUTTER_VERSION: "3.8.1"
  DART_VERSION: "2.19.1"

jobs:
  # Code Quality & Testing
  analyze:
    name: Analyze & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ðŸ” Verify Flutter installation
      run: flutter doctor -v
      
    - name: ðŸ“‹ Get dependencies
      run: flutter pub get
      
    - name: ðŸ“ Generate code
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: ðŸ” Analyze code
      run: flutter analyze
      
    - name: ðŸ§ª Run tests
      run: flutter test --coverage
      
    - name: ðŸ“Š Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        name: easy-loan-coverage
        fail_ci_if_error: false

  # Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”’ Run security audit
      run: |
        flutter pub deps
        flutter pub audit
        
    - name: ðŸ›¡ï¸ Run dependency check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'Easy Loan'
        path: '.'
        format: 'ALL'
        
    - name: ðŸ“‹ Upload security results
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: reports/

  # Build for Android
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [analyze, security]
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'zulu'
        
    - name: ðŸ“‹ Get dependencies
      run: flutter pub get
      
    - name: ðŸ“ Generate code
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: ðŸ”¨ Build APK (Debug)
      run: flutter build apk --debug
      
    - name: ðŸ”¨ Build APK (Release)
      if: github.event_name == 'release'
      run: flutter build apk --release
      
    - name: ðŸ”¨ Build AAB (Release)
      if: github.event_name == 'release'
      run: flutter build appbundle --release
      
    - name: ðŸ“‹ Upload APK artifacts
      uses: actions/upload-artifact@v3
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/
        
    - name: ðŸ“‹ Upload AAB artifacts
      if: github.event_name == 'release'
      uses: actions/upload-artifact@v3
      with:
        name: android-aab
        path: build/app/outputs/bundle/release/

  # Build for iOS
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: [analyze, security]
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ðŸ“‹ Get dependencies
      run: flutter pub get
      
    - name: ðŸ“ Generate code
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: ðŸ”¨ Build iOS (Debug)
      run: flutter build ios --debug --no-codesign
      
    - name: ðŸ”¨ Build iOS (Release)
      if: github.event_name == 'release'
      run: flutter build ios --release --no-codesign
      
    - name: ðŸ“‹ Upload iOS artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ios-build
        path: build/ios/iphoneos/

  # Build for Web
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: [analyze, security]
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ðŸ“‹ Get dependencies
      run: flutter pub get
      
    - name: ðŸ“ Generate code
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: ðŸ”¨ Build Web
      run: flutter build web --release
      
    - name: ðŸ“‹ Upload Web artifacts
      uses: actions/upload-artifact@v3
      with:
        name: web-build
        path: build/web/

  # Smart Contract Testing
  contract-test:
    name: Smart Contract Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“‹ Install dependencies
      working-directory: contracts
      run: npm install
      
    - name: ðŸ”¨ Compile contracts
      working-directory: contracts
      run: npx hardhat compile
      
    - name: ðŸ§ª Run contract tests
      working-directory: contracts
      run: npx hardhat test
      
    - name: ðŸ” Run coverage
      working-directory: contracts
      run: npx hardhat coverage
      
    - name: ðŸ“Š Upload contract coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./contracts/coverage/lcov.info
        name: smart-contract-coverage
        fail_ci_if_error: false

  # Deploy to GitHub Pages (Web Build)
  deploy-web:
    name: Deploy Web to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-web]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ðŸ“¦ Download web artifacts
      uses: actions/download-artifact@v3
      with:
        name: web-build
        path: ./web-build
        
    - name: ðŸ“„ Setup Pages
      uses: actions/configure-pages@v3
      
    - name: ðŸ“‹ Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./web-build
        
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # Create Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, build-web, contract-test]
    if: github.event_name == 'release'
    
    steps:
    - name: ðŸ“¦ Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: ðŸ“‹ Create release notes
      run: |
        echo "## ðŸš€ Easy Loan Release" > release-notes.md
        echo "" >> release-notes.md
        echo "### ðŸ“± Mobile Apps" >> release-notes.md
        echo "- Android APK and AAB builds included" >> release-notes.md
        echo "- iOS build available for TestFlight distribution" >> release-notes.md
        echo "" >> release-notes.md
        echo "### ðŸŒ Web Application" >> release-notes.md
        echo "- Deployed to GitHub Pages" >> release-notes.md
        echo "" >> release-notes.md
        echo "### ðŸ”— Blockchain Integration" >> release-notes.md
        echo "- Smart contracts tested and verified" >> release-notes.md
        echo "- Ethereum Sepolia testnet compatible" >> release-notes.md
        
    - name: ðŸ“¦ Add assets to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          android-apk/*
          android-aab/*
        body_path: release-notes.md
        draft: false
        prerelease: false

  # Notification
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, build-web, contract-test]
    if: always()
    
    steps:
    - name: ðŸ“§ Send notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#easy-loan-dev'
        text: |
          Easy Loan CI/CD Pipeline completed!
          Status: ${{ job.status }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
